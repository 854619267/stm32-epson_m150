#include "epson_m150ii.h"
#include "sys.h"

PRINTER_CTR_TYPE p_ctr;

//----- 信号之间互相屏蔽变量(互斥) ----- //
uint8_t g_bTimingIntr;	
uint8_t g_bResetIntr;		

void GPIO_ToggleBit(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin)
{
	if(GPIO_ReadOutputDataBit(GPIOx, GPIO_Pin) == Bit_SET)
	{
		GPIO_ResetBits(GPIOx, GPIO_Pin);
	}
	else
	{
		GPIO_SetBits(GPIOx, GPIO_Pin);
	}
}

// Printer IO Init
void Printer_IO_Config(void)
{
	GPIO_InitTypeDef    GPIO_InitStructure;
	EXTI_InitTypeDef 	EXTI_InitStructure;	

	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO | RCC_APB2Periph_GPIOB , ENABLE);		//  open clock GPIOB, AFIO clock
//	GPIO_PinRemapConfig(GPIO_Remap_SWJ_JTAGDisable,ENABLE);
	
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// A
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin =  PTA_PIN;
	GPIO_Init(PTA_PORT, &GPIO_InitStructure);	

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// B
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin =  PTB_PIN;
	GPIO_Init(PTB_PORT, &GPIO_InitStructure);	

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// C
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin =  PTC_PIN;
	GPIO_Init(PTC_PORT, &GPIO_InitStructure);	

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// D
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin =  PTD_PIN;
	GPIO_Init(PTD_PORT, &GPIO_InitStructure);	
	
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// 配置 LED1(PB14) 引脚 (不是必须)
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_14;
	GPIO_Init(GPIOB, &GPIO_InitStructure);
	GPIO_SetBits(GPIOB, GPIO_Pin_14);	// 关闭

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// 配置 LED2(PB15) 引脚 (不是必须)
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_15;
	GPIO_Init(GPIOB, &GPIO_InitStructure);
	GPIO_SetBits(GPIOB, GPIO_Pin_15);	// 关闭

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;			// Motor
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin =  MOTER_PIN;
	GPIO_Init(MOTER_PORT, &GPIO_InitStructure);	
	
	/******************  TIMGIMG 外部中断 ******************/
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;			// Timing 
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_IN_FLOATING;
	GPIO_InitStructure.GPIO_Pin =  PT_TIMER_PIN;
	GPIO_Init(PT_TIMER_PORT, &GPIO_InitStructure);	

	EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;
	EXTI_InitStructure.EXTI_Line = EXTI_Line6;
	EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Rising_Falling;		// EXTI_Trigger_Rising_Falling
	EXTI_InitStructure.EXTI_LineCmd = ENABLE;
	EXTI_Init(&EXTI_InitStructure);		
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOB, GPIO_PinSource6);
	EXTI_ClearITPendingBit(EXTI_Line6);		// Clean Timing IT Flag

	/******************  Reset Signal 外部中断 ******************/
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_IPU;
	GPIO_InitStructure.GPIO_Pin =  PT_RESET_DETCT_PIN;
	GPIO_Init(PT_RESET_DETCT_PORT, &GPIO_InitStructure);	
	
	EXTI_InitStructure.EXTI_Mode = EXTI_Mode_Interrupt;
	EXTI_InitStructure.EXTI_Line = EXTI_Line12;
 	EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Falling;		// 下降沿触发	
 	EXTI_InitStructure.EXTI_LineCmd = ENABLE;
	EXTI_Init(&EXTI_InitStructure);
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOB, GPIO_PinSource12);
	EXTI_ClearITPendingBit(EXTI_Line12);		// Clean Timing IT Flag
}

// 打印前初始化
void printer_timer_init(void)
{
	p_ctr.r_h = 0;
	p_ctr.t_h = 0;
	p_ctr.t_num = 0;
}

// 横向取模
// 这是一个 5x7 的 ASCII 码字库的数组。一共有 96 个可打印的 ASCII码。
unsigned char const ascii_5x7[96][7]={
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,//' ' 	1
	0x04,0x04,0x04,0x04,0x04,0x00,0x04,//'!' 	2
	0x05,0x05,0x05,0x00,0x00,0x00,0x00,//'"' 	3
	0x0A,0x0A,0x1F,0x0A,0x1F,0x0A,0x0A,//'#' 	4
	0x04,0x1E,0x05,0x0E,0x14,0x0F,0x04,//'$' 	5
	0x03,0x13,0x08,0x04,0x02,0x19,0x18,//'%' 	6
	0x06,0x09,0x05,0x02,0x15,0x09,0x16,//'&' 	7
	0x03,0x02,0x01,0x00,0x00,0x00,0x00,//''' 	8
	0x04,0x02,0x01,0x01,0x01,0x02,0x04,//'(' 	9
	0x01,0x02,0x04,0x04,0x04,0x02,0x01,//')' 	10
	0x00,0x0A,0x04,0x1F,0x04,0x0A,0x00,//'*' 	11
	0x00,0x04,0x04,0x1F,0x04,0x04,0x00,//'+' 	12
	0x00,0x00,0x00,0x00,0x03,0x02,0x01,//',' 	13
	0x00,0x00,0x00,0x1F,0x00,0x00,0x00,//'-' 	14
	0x00,0x00,0x00,0x00,0x00,0x03,0x03,//'.' 	15
	0x00,0x10,0x08,0x04,0x02,0x01,0x00,//'/' 	16
	0x0E,0x11,0x19,0x15,0x13,0x11,0x0E,//'0' 	17
	0x04,0x06,0x04,0x04,0x04,0x04,0x0E,//'1' 	18
	0x0E,0x11,0x10,0x0C,0x02,0x01,0x1F,//'2' 	19
	0x0E,0x11,0x10,0x0C,0x10,0x11,0x0E,//'3' 	20
	0x08,0x0C,0x0A,0x09,0x1F,0x08,0x08,//'4' 	21
	0x1F,0x01,0x0F,0x10,0x10,0x11,0x0E,//'5' 	22
	0x0C,0x02,0x01,0x0F,0x11,0x11,0x0E,//'6' 	23
	0x1F,0x10,0x08,0x04,0x02,0x02,0x02,//'7' 	24
	0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E,//'8' 	25
	0x0E,0x11,0x11,0x1E,0x10,0x08,0x06,//'9' 	26
	0x00,0x03,0x03,0x00,0x03,0x03,0x00,//':' 	27
	0x00,0x03,0x03,0x00,0x03,0x02,0x01,//';' 	28
	0x08,0x04,0x02,0x01,0x02,0x04,0x08,//'<' 	29
	0x00,0x00,0x1F,0x00,0x1F,0x00,0x00,//'=' 	30
	0x01,0x02,0x04,0x08,0x04,0x02,0x01,//'>' 	31
	0x0E,0x11,0x10,0x08,0x04,0x00,0x04,//'?' 	32
	0x0E,0x11,0x10,0x16,0x15,0x15,0x0E,//'@' 	33
	0x0E,0x11,0x11,0x1F,0x11,0x11,0x11,//'A' 	34
	0x0F,0x11,0x11,0x0F,0x11,0x11,0x0F,//'B' 	35
	0x0E,0x11,0x01,0x01,0x01,0x11,0x0E,//'C' 	36
	0x07,0x09,0x11,0x11,0x11,0x09,0x07,//'D' 	37
	0x1F,0x01,0x01,0x0F,0x01,0x01,0x1F,//'E' 	38
	0x1F,0x01,0x01,0x0F,0x01,0x01,0x01,//'F' 	39
	0x0E,0x11,0x01,0x01,0x19,0x11,0x1E,//'G' 	40
	0x11,0x11,0x11,0x1F,0x11,0x11,0x11,//'H' 	41
	0x07,0x02,0x02,0x02,0x02,0x02,0x07,//'I' 	42
	0x1C,0x08,0x08,0x08,0x08,0x09,0x06,//'J' 	43
	0x11,0x09,0x05,0x03,0x05,0x09,0x11,//'K' 	44
	0x01,0x01,0x01,0x01,0x01,0x01,0x1F,//'L' 	45
	0x11,0x1B,0x15,0x15,0x11,0x11,0x11,//'M' 	46
	0x11,0x11,0x13,0x15,0x19,0x11,0x11,//'N' 	47
	0x0E,0x11,0x11,0x11,0x11,0x11,0x0E,//'O' 	48
	0x0F,0x11,0x11,0x0F,0x01,0x01,0x01,//'P' 	49
	0x0E,0x11,0x11,0x11,0x15,0x09,0x16,//'Q' 	50
	0x0F,0x11,0x11,0x0F,0x05,0x09,0x11,//'R' 	51
	0x0E,0x11,0x01,0x0E,0x10,0x11,0x0E,//'S' 	52
	0x1F,0x04,0x04,0x04,0x04,0x04,0x04,//'T' 	53
	0x11,0x11,0x11,0x11,0x11,0x11,0x0E,//'U' 	54
	0x11,0x11,0x11,0x11,0x11,0x0A,0x04,//'V' 	55
	0x11,0x11,0x11,0x15,0x15,0x15,0x0A,//'W' 	56
	0x11,0x11,0x0A,0x04,0x0A,0x11,0x11,//'X' 	57
	0x11,0x11,0x0A,0x04,0x04,0x04,0x04,//'Y' 	58
	0x1F,0x10,0x08,0x04,0x02,0x01,0x1F,//'Z' 	59
	0x07,0x01,0x01,0x01,0x01,0x01,0x07,//'[' 	60
	0x00,0x01,0x02,0x04,0x08,0x10,0x00,//'\' 	61
	0x07,0x04,0x04,0x04,0x04,0x04,0x07,//']' 	62
	0x04,0x0A,0x11,0x00,0x00,0x00,0x00,//'^' 	63
	0x00,0x00,0x00,0x00,0x00,0x00,0x1F,//'_' 	64
	0x01,0x02,0x04,0x00,0x00,0x00,0x00,//'`' 	65
	0x00,0x00,0x0E,0x10,0x1E,0x11,0x1E,//'a' 	66
	0x01,0x01,0x0D,0x13,0x11,0x11,0x0F,//'b' 	67
	0x00,0x00,0x06,0x09,0x01,0x09,0x06,//'c' 	68
	0x10,0x10,0x16,0x19,0x11,0x11,0x1E,//'d' 	69
	0x00,0x00,0x0E,0x11,0x1F,0x01,0x0E,//'e' 	70
	0x04,0x0A,0x02,0x07,0x02,0x02,0x02,//'f' 	71
	0x00,0x1E,0x11,0x11,0x1E,0x10,0x0E,//'g' 	72
	0x01,0x01,0x0D,0x13,0x11,0x11,0x11,//'h' 	73
	0x01,0x00,0x01,0x01,0x01,0x01,0x01,//'i' 	74
	0x04,0x00,0x06,0x04,0x04,0x04,0x03,//'j' 	75
	0x01,0x01,0x09,0x05,0x03,0x05,0x09,//'k' 	76
	0x03,0x02,0x02,0x02,0x02,0x02,0x07,//'l' 	77
	0x00,0x00,0x0B,0x15,0x11,0x11,0x11,//'m' 	78
	0x00,0x00,0x0D,0x0B,0x09,0x09,0x09,//'n' 	79
	0x00,0x00,0x06,0x09,0x09,0x09,0x06,//'o' 	80
	0x00,0x07,0x09,0x09,0x07,0x01,0x01,//'p' 	81
	0x00,0x0E,0x09,0x09,0x0E,0x08,0x08,//'q' 	82
	0x00,0x00,0x05,0x03,0x01,0x01,0x01,//'r' 	83
	0x00,0x00,0x0E,0x01,0x06,0x08,0x07,//'s' 	84
	0x02,0x02,0x07,0x02,0x02,0x02,0x02,//'t' 	85
	0x00,0x00,0x09,0x09,0x09,0x09,0x0E,//'u' 	86
	0x00,0x00,0x11,0x11,0x11,0x0A,0x04,//'v' 	87
	0x00,0x00,0x11,0x11,0x15,0x15,0x0A,//'w' 	88
	0x00,0x00,0x11,0x0A,0x04,0x0A,0x11,//'x' 	89
	0x00,0x09,0x09,0x09,0x0E,0x08,0x06,//'y' 	90
	0x00,0x00,0x1F,0x08,0x04,0x02,0x1F,//'z' 	91
	0x04,0x02,0x02,0x01,0x02,0x02,0x04,//'{' 	92
	0x02,0x02,0x02,0x02,0x02,0x02,0x02,//'|' 	93
	0x01,0x02,0x02,0x04,0x02,0x02,0x01,//'}' 	94
	0x16,0x09,0x00,0x00,0x00,0x00,0x00,//'~' 	95
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,//'?' 	96
};

unsigned char const ascii_test[12][7]={
	0x0E,0x11,0x11,0x1F,0x11,0x11,0x11,//'A' 	34
	0x0F,0x11,0x11,0x0F,0x11,0x11,0x0F,//'B' 	35
	0x0E,0x11,0x01,0x01,0x01,0x11,0x0E,//'C' 	36
	0x07,0x09,0x11,0x11,0x11,0x09,0x07,//'D' 	37
	0x1F,0x01,0x01,0x0F,0x01,0x01,0x1F,//'E' 	38
	0x1F,0x01,0x01,0x0F,0x01,0x01,0x01,//'F' 	39
	0x0E,0x11,0x01,0x01,0x19,0x11,0x1E,//'G' 	40
	0x11,0x11,0x11,0x1F,0x11,0x11,0x11,//'H' 	41
	0x07,0x02,0x02,0x02,0x02,0x02,0x07,//'I' 	42
//	0x1C,0x08,0x08,0x08,0x08,0x09,0x06,//'J' 	43
//	0x11,0x09,0x05,0x03,0x05,0x09,0x11,//'K' 	44
//	0x01,0x01,0x01,0x01,0x01,0x01,0x1F,//'L' 	45
};	

u8 print_real[7][12];		// 需要打印缓存的 buffer 


//u8 print_real[7][12]=
//{
   //{`0`   `1`  `2`   `3`   `4`   `5`  `6`  `7`   `8`   `9`	 '(' ')'} ----- //
/*
	{0x0E,0x04,0x0E,0x0E,0x08,0x1F,0x0C,0x1F,0x0E,0x0E,0x04,0x01}, 
	{0x11,0x06,0x11,0x11,0x0C,0x01,0x02,0x10,0x11,0x11,0x02,0x02}, 
	{0x09,0x04,0x10,0x10,0x0A,0x0F,0x01,0x08,0x11,0x11,0x01,0x04},
	{0x15,0x04,0x0C,0x0C,0x09,0x10,0x0F,0x04,0x0E,0x1E,0x01,0x04},
	{0x13,0x04,0x02,0x10,0x1F,0x10,0x11,0x02,0x11,0x10,0x01,0x04},
	{0x11,0x04,0x01,0x11,0x08,0x11,0x11,0x02,0x11,0x08,0x02,0x02},
	{0x0E,0x0E,0x1F,0x0E,0x08,0x0E,0x0E,0x02,0x0E,0x06,0x04,0x01},
*/
/*
	0x0E,0x04,0x0E,0x0E,0x08,0x1F,0x0C,0x1F,0x0E,0x0E,0x00,0x00, 
	0x11,0x06,0x11,0x11,0x0C,0x01,0x02,0x10,0x11,0x11,0x00,0x00,
	0x09,0x04,0x10,0x10,0x0A,0x0F,0x01,0x08,0x11,0x11,0x00,0x00,
	0x15,0x04,0x0C,0x0C,0x09,0x10,0x0F,0x04,0x0E,0x1E,0x00,0x00,
	0x13,0x04,0x02,0x10,0x1F,0x10,0x11,0x02,0x11,0x10,0x00,0x00,
	0x11,0x04,0x01,0x11,0x08,0x11,0x11,0x02,0x11,0x08,0x00,0x00,
	0x0E,0x0E,0x1F,0x0E,0x08,0x0E,0x0E,0x02,0x0E,0x06,0x00,0x00,
*/
//};		

const u8 dot_a[] = {1,5, 9,13,17,21,25,29,33,37,41,45,49,53,57,61,65,69,73,77,81,85,89,93,97};
const u8 dot_b[] = {2,6,10,14,18,22,26,30,34,38,42,46,50,54,58,62,66,70,74,78,82,86,90,94,98};
const u8 dot_c[] = {3,7,11,15,19,23,27,31,35,39,43,47,51,55,59,63,67,71,75,79,83,87,91,95,99};
const u8 dot_d[] = {4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100};
u8 a_i = 0;		// 记录 Head_a 所在位置的变量
u8 b_i = 0;		// 记录 Head_b 所在位置的变量
u8 c_i = 0;		// 记录 Head_c 所在位置的变量
u8 d_i = 0;		// 记录 Head_d 所在位置的变量

// a 是取到当前打印行所需要打印的长度, b 代表一行固定的总长度( 当前固定的总长度12 )
#define Max(a,b)	((a) < (b)?(b):(a))

// 矩阵倒置函数
void print_matrix_invert(void)
{
	int x, y, i = 0, maxlen;
	int len_obtain = 9; int len_line = 12;	// len_obtain 获取的数据长度(根据)

/*
	// 先进行右对齐处理, 再倒置
	maxlen = Max(len_obtain, len_line);		// 第一个为当前需要打印的
//	if((i+len1) % maxlen)
	if(len_obtain != len_line)	// 如果取到的字节数不等于一行的字节数, 那么将它补齐
	{
		for(x = 0;x < len_line - len_obtain; x++)
		{
			for(y = 0;y < 7; y++)
			{
				print_real[x][y] = 0x00;
				//print_real[x][y] = ascii_test[y][x];   // 将字库补齐
			}
		}
	
		memcpy(print_real[x+1][y], ascii_test, sizeof(ascii_test));		// 补齐后将打印的信息拷贝到后面
	}
*/
	
	// 将打印的一行倒置, 即点阵进行翻转
	for(x = 0;x < 7; x++)
	{
		for(y = 0;y < 12; y++)
		{
			print_real[x][y] = ascii_test[y][x];  
		}
	}


	
}
	
// Print line 
void printer_line(void)
{
	u8 space_line = 5;

	if(g_bTimingIntr)	 // if receive Timing signal, close A\B\C\D, t_num ++ util > 97!
	{
		PTA_OFF();PTB_OFF();PTC_OFF();PTD_OFF();
	
		g_bTimingIntr = 0;
		p_ctr.t_num ++;
	}
	
	if(g_bResetIntr)	// if receive Reset signal, print line finish, line_num++ 
	{
		g_bResetIntr = 0;
		p_ctr.line_num ++;

		p_ctr.t_num = 0;
		p_ctr.t_num_back = 0;

		a_i = 0;
		b_i = 0;
		c_i = 0;
		d_i = 0;
	}

	if(p_ctr.line_num > 7 + space_line)	// p_ctr.line_num  每个点阵的行数(The number of rows in each dot matrix.)
	{																		// do space_line print
		MOTER_OFF();
		PTA_OFF();
		PTB_OFF();
		PTC_OFF();
		PTD_OFF();
		p_ctr.line_num = 0;
		p_ctr.t_num = 0;
		p_ctr.t_num_back = 0;
		p_ctr.p_on = 0;
	}
	
	if(d_i > 23)
	{
		a_i = 0;
		b_i = 0;
		c_i = 0;
		d_i = 0;
	}
	
	// Judge printer head work logic
	if((p_ctr.t_num < 97) && (p_ctr.t_num != p_ctr.t_num_back) && (p_ctr.line_num > space_line))
	{
		p_ctr.t_num_back = p_ctr.t_num;
		
		/* A */
		if(p_ctr.t_num == dot_a[a_i])
		{
			if((print_real[p_ctr.line_num-1-space_line][a_i >> 3] & (0x01 << (a_i & 0x07))))
			{
				PTA_ON();
			}else
			{
				PTA_OFF();
			}
			a_i++;
		}

		/* B */
		if(p_ctr.t_num == dot_b[b_i])
		{
			if((print_real[p_ctr.line_num-1-space_line][(b_i >> 3) + 3] & (0x01 << (b_i & 0x07))))
			{
				PTB_ON();
			}else
			{
				PTB_OFF();
			}
			b_i++;
		}

		/* C */
		if(p_ctr.t_num == dot_c[c_i])
		{
			if((print_real[p_ctr.line_num-1-space_line][(c_i >> 3) + 6] & (0x01 << (c_i & 0x07))))
			{
				PTC_ON();
			}else
			{
				PTC_OFF();
			}
			c_i++;
		}

		/* D */
		if(p_ctr.t_num == dot_d[d_i])
		{
			if((print_real[p_ctr.line_num-1-space_line][(d_i >> 3) + 9] & (0x01 << (d_i & 0x07))))
			{
				PTD_ON();
			}else
			{
				PTD_OFF();
			}
			d_i++;
		}
	}
}


